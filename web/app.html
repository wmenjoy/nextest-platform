<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊµãËØïÁÆ°ÁêÜÂπ≥Âè∞</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/reset.css">
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #root { height: 100vh; }
        .app-layout { height: 100vh; }
        .logo {
            height: 32px; margin: 16px; background: rgba(255, 255, 255, 0.2);
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold;
        }
        .group-tree-item {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%;
        }
        .group-tree-actions {
            opacity: 0;
            transition: opacity 0.15s;
            display: flex;
            gap: 2px; /* Compact spacing between buttons */
        }
        .group-tree-item:hover .group-tree-actions {
            opacity: 1;
        }
        .group-tree-actions .ant-btn {
            min-width: 24px;
            height: 24px;
            padding: 0 4px;
            font-size: 14px;
            line-height: 22px;
        }
        .json-viewer {
            background: #f5f5f5; padding: 12px; border-radius: 4px;
            font-family: 'Courier New', monospace; font-size: 12px;
            max-height: 400px; overflow: auto; white-space: pre-wrap;
        }
        .group-has-target {
            color: #52c41a;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/antd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.6/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const {
            Layout, Menu, Button, Table, Space, Modal, Form, Input, Select,
            Tag, message, Popconfirm, Drawer, Descriptions, Tree, Card,
            Statistic, Row, Col, Dropdown, Tooltip
        } = antd;

        const { Header, Content, Sider } = Layout;
        const { Option } = Select;
        const { TextArea } = Input;
        const API_BASE = '/api/v2';

        function App() {
            const [loading, setLoading] = useState(false);
            const [groups, setGroups] = useState([]);
            const [tests, setTests] = useState([]);
            const [selectedGroup, setSelectedGroup] = useState(null);
            const [stats, setStats] = useState({});

            // Test modals
            const [createTestModalVisible, setCreateTestModalVisible] = useState(false);
            const [editTestModalVisible, setEditTestModalVisible] = useState(false);
            const [testHistoryDrawerVisible, setTestHistoryDrawerVisible] = useState(false);

            // Group modals
            const [createGroupModalVisible, setCreateGroupModalVisible] = useState(false);
            const [editGroupModalVisible, setEditGroupModalVisible] = useState(false);
            const [currentGroup, setCurrentGroup] = useState(null);
            const [parentGroupForCreate, setParentGroupForCreate] = useState(null); // Áî®‰∫éËøΩË∏™Ê≠£Âú®‰∏∫Âì™‰∏™Áà∂ÂàÜÁªÑÂàõÂª∫Â≠êÂàÜÁªÑ

            const [currentTest, setCurrentTest] = useState(null);
            const [testResults, setTestResults] = useState([]);
            const [executing, setExecuting] = useState({});

            const [testForm] = Form.useForm();
            const [editTestForm] = Form.useForm();
            const [groupForm] = Form.useForm();
            const [editGroupForm] = Form.useForm();

            const loadGroups = useCallback(async () => {
                try {
                    const response = await fetch(`${API_BASE}/groups/tree`);
                    const data = await response.json();
                    setGroups(data || []);
                } catch (error) {
                    message.error('Âä†ËΩΩÂàÜÁªÑÂ§±Ë¥•');
                }
            }, []);

            const loadTests = useCallback(async (groupId = null) => {
                setLoading(true);
                try {
                    const response = await fetch(`${API_BASE}/tests?limit=100`);
                    const data = await response.json();
                    let filteredTests = data.data || [];
                    if (groupId) {
                        filteredTests = filteredTests.filter(t => t.groupId === groupId);
                    }
                    setTests(filteredTests);
                } catch (error) {
                    message.error('Âä†ËΩΩÊµãËØïÂ§±Ë¥•');
                }
                setLoading(false);
            }, []);

            const loadStats = useCallback(async () => {
                try {
                    const response = await fetch(`${API_BASE}/tests/stats`);
                    const data = await response.json();
                    if (data.success) {
                        setStats(data.data);
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩÁªüËÆ°Â§±Ë¥•');
                }
            }, []);

            useEffect(() => {
                loadGroups();
                loadTests();
                loadStats();
            }, [loadGroups, loadTests, loadStats]);

            // ===== Group Management =====

            const handleCreateGroup = async (values) => {
                try {
                    const payload = {
                        groupId: values.groupId,
                        name: values.name,
                        parentId: values.parentId || '',
                        description: values.description || '',
                        targetHost: values.targetHost || ''
                    };

                    const response = await fetch(`${API_BASE}/groups`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        message.success('ÂàõÂª∫ÂàÜÁªÑÊàêÂäü');
                        setCreateGroupModalVisible(false);
                        groupForm.resetFields();
                        setParentGroupForCreate(null);
                        loadGroups();
                    } else {
                        const error = await response.json();
                        message.error('ÂàõÂª∫Â§±Ë¥•: ' + error.error);
                    }
                } catch (error) {
                    message.error('ÂàõÂª∫Â§±Ë¥•: ' + error.message);
                }
            };

            const handleCreateSubGroup = (parentGroup) => {
                setParentGroupForCreate(parentGroup);
                groupForm.setFieldsValue({
                    parentId: parentGroup.groupId
                });
                setCreateGroupModalVisible(true);
            };

            const handleEditGroup = (group) => {
                setCurrentGroup(group);
                editGroupForm.setFieldsValue({
                    name: group.name,
                    description: group.description || '',
                    targetHost: group.targetHost || ''
                });
                setEditGroupModalVisible(true);
            };

            const handleUpdateGroup = async (values) => {
                try {
                    const payload = {
                        name: values.name,
                        description: values.description || '',
                        targetHost: values.targetHost || ''
                    };

                    const response = await fetch(`${API_BASE}/groups/${currentGroup.groupId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        message.success('Êõ¥Êñ∞ÂàÜÁªÑÊàêÂäü');
                        setEditGroupModalVisible(false);
                        editGroupForm.resetFields();
                        setCurrentGroup(null);
                        loadGroups();
                    } else {
                        message.error('Êõ¥Êñ∞Â§±Ë¥•');
                    }
                } catch (error) {
                    message.error('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message);
                }
            };

            const handleDeleteGroup = async (groupId) => {
                try {
                    const response = await fetch(`${API_BASE}/groups/${groupId}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        message.success('Âà†Èô§ÂàÜÁªÑÊàêÂäü');
                        loadGroups();
                        if (selectedGroup === groupId) {
                            setSelectedGroup(null);
                            loadTests();
                        }
                    } else {
                        message.error('Âà†Èô§Â§±Ë¥•');
                    }
                } catch (error) {
                    message.error('Âà†Èô§Â§±Ë¥•');
                }
            };

            // ===== Test Management =====

            const handleCreateTest = async (values) => {
                try {
                    const payload = {
                        testId: values.testId,
                        groupId: values.groupId,
                        name: values.name,
                        type: values.type,
                        priority: values.priority || 'P1',
                        objective: values.objective,
                        http: values.type === 'http' ? {
                            method: values.httpMethod,
                            path: values.httpPath,
                            headers: values.httpHeaders ? JSON.parse(values.httpHeaders) : {},
                            body: values.httpBody ? JSON.parse(values.httpBody) : null
                        } : undefined,
                        command: values.type === 'command' ? {
                            cmd: values.cmdCommand,
                            args: values.cmdArgs ? values.cmdArgs.split(' ') : [],
                            timeout: parseInt(values.cmdTimeout) || 60
                        } : undefined,
                        assertions: values.assertions ? JSON.parse(values.assertions) : [],
                        tags: values.tags ? values.tags.split(',').map(t => t.trim()) : [],
                        setupHooks: values.setupHooks ? JSON.parse(values.setupHooks) : [],
                        teardownHooks: values.teardownHooks ? JSON.parse(values.teardownHooks) : []
                    };

                    const response = await fetch(`${API_BASE}/tests`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        message.success('ÂàõÂª∫ÊàêÂäü');
                        setCreateTestModalVisible(false);
                        testForm.resetFields();
                        loadTests(selectedGroup);
                        loadStats();
                    } else {
                        const error = await response.json();
                        message.error('ÂàõÂª∫Â§±Ë¥•: ' + error.error);
                    }
                } catch (error) {
                    message.error('ÂàõÂª∫Â§±Ë¥•: ' + error.message);
                }
            };

            const handleEditTest = (test) => {
                setCurrentTest(test);
                editTestForm.setFieldsValue({
                    name: test.name,
                    type: test.type,
                    priority: test.priority,
                    objective: test.objective,
                    httpMethod: test.http?.method,
                    httpPath: test.http?.path,
                    httpHeaders: test.http?.headers ? JSON.stringify(test.http.headers, null, 2) : '',
                    httpBody: test.http?.body ? JSON.stringify(test.http.body, null, 2) : '',
                    cmdCommand: test.command?.cmd,
                    cmdArgs: test.command?.args ? test.command.args.join(' ') : '',
                    cmdTimeout: test.command?.timeout || 60,
                    cmdCwd: test.command?.cwd || '',
                    assertions: test.assertions ? JSON.stringify(test.assertions, null, 2) : '',
                    tags: test.tags ? test.tags.join(', ') : '',
                    setupHooks: test.setupHooks ? JSON.stringify(test.setupHooks, null, 2) : '',
                    teardownHooks: test.teardownHooks ? JSON.stringify(test.teardownHooks, null, 2) : ''
                });
                setEditTestModalVisible(true);
            };

            const handleUpdateTest = async (values) => {
                try {
                    const payload = {
                        name: values.name,
                        priority: values.priority,
                        objective: values.objective,
                        http: values.type === 'http' ? {
                            method: values.httpMethod,
                            path: values.httpPath,
                            headers: values.httpHeaders ? JSON.parse(values.httpHeaders) : {},
                            body: values.httpBody ? JSON.parse(values.httpBody) : null
                        } : undefined,
                        command: values.type === 'command' ? {
                            cmd: values.cmdCommand,
                            args: values.cmdArgs ? values.cmdArgs.split(' ') : [],
                            timeout: parseInt(values.cmdTimeout) || 60,
                            cwd: values.cmdCwd || ''
                        } : undefined,
                        assertions: values.assertions ? JSON.parse(values.assertions) : [],
                        tags: values.tags ? values.tags.split(',').map(t => t.trim()) : [],
                        setupHooks: values.setupHooks ? JSON.parse(values.setupHooks) : [],
                        teardownHooks: values.teardownHooks ? JSON.parse(values.teardownHooks) : []
                    };

                    const response = await fetch(`${API_BASE}/tests/${currentTest.testId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        message.success('Êõ¥Êñ∞ÊàêÂäü');
                        setEditTestModalVisible(false);
                        editTestForm.resetFields();
                        setCurrentTest(null);
                        loadTests(selectedGroup);
                    } else {
                        message.error('Êõ¥Êñ∞Â§±Ë¥•');
                    }
                } catch (error) {
                    message.error('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message);
                }
            };

            const handleDeleteTest = async (testId) => {
                try {
                    const response = await fetch(`${API_BASE}/tests/${testId}`, { method: 'DELETE' });
                    if (response.ok) {
                        message.success('Âà†Èô§ÊàêÂäü');
                        loadTests(selectedGroup);
                        loadStats();
                    } else {
                        message.error('Âà†Èô§Â§±Ë¥•');
                    }
                } catch (error) {
                    message.error('Âà†Èô§Â§±Ë¥•');
                }
            };

            const handleExecuteTest = async (testId) => {
                setExecuting(prev => ({ ...prev, [testId]: true }));
                try {
                    const response = await fetch(`${API_BASE}/tests/${testId}/execute`, { method: 'POST' });
                    if (response.ok) {
                        message.success('ÊµãËØïÊâßË°åÂÆåÊàê');
                        loadTests(selectedGroup);
                    } else {
                        message.error('ÊâßË°åÂ§±Ë¥•');
                    }
                } catch (error) {
                    message.error('ÊâßË°åÂ§±Ë¥•');
                } finally {
                    setExecuting(prev => ({ ...prev, [testId]: false }));
                }
            };

            const handleViewHistory = async (test) => {
                setCurrentTest(test);
                setTestHistoryDrawerVisible(true);
                try {
                    const response = await fetch(`${API_BASE}/tests/${test.testId}/history?limit=10`);
                    const data = await response.json();
                    setTestResults(data || []);
                } catch (error) {
                    message.error('Âä†ËΩΩÂéÜÂè≤Â§±Ë¥•');
                }
            };

            // ===== Tree Data =====

            const buildTreeData = (groupsList) => {
                return groupsList.map(group => ({
                    title: (
                        <div className="group-tree-item">
                            <span className={group.targetHost ? 'group-has-target' : ''}>
                                {group.targetHost ? 'üéØ ' : 'üìÅ '}{group.name}
                            </span>
                            <div className="group-tree-actions">
                                <Tooltip title="Ê∑ªÂä†Â≠êÂàÜÁªÑ">
                                    <Button
                                        type="text"
                                        size="small"
                                        onClick={(e) => { e.stopPropagation(); handleCreateSubGroup(group); }}
                                    >
                                        ‚ûï
                                    </Button>
                                </Tooltip>
                                <Tooltip title="ÁºñËæëÂàÜÁªÑ">
                                    <Button
                                        type="text"
                                        size="small"
                                        onClick={(e) => { e.stopPropagation(); handleEditGroup(group); }}
                                    >
                                        ‚úèÔ∏è
                                    </Button>
                                </Tooltip>
                                <Popconfirm
                                    title="Á°ÆÂÆöÂà†Èô§ÂàÜÁªÑÔºü"
                                    onConfirm={(e) => { e.stopPropagation(); handleDeleteGroup(group.groupId); }}
                                    okText="Á°ÆÂÆö"
                                    cancelText="ÂèñÊ∂à"
                                >
                                    <Button
                                        type="text"
                                        size="small"
                                        danger
                                        onClick={(e) => e.stopPropagation()}
                                    >
                                        üóëÔ∏è
                                    </Button>
                                </Popconfirm>
                            </div>
                        </div>
                    ),
                    key: group.groupId,
                    children: group.children ? buildTreeData(group.children) : undefined
                }));
            };

            const testColumns = [
                { title: 'ID', dataIndex: 'testId', key: 'testId', width: 200, ellipsis: true },
                { title: 'ÂêçÁß∞', dataIndex: 'name', key: 'name', ellipsis: true },
                {
                    title: 'Á±ªÂûã',
                    dataIndex: 'type',
                    key: 'type',
                    width: 100,
                    render: (type) => <Tag color={type === 'http' ? 'blue' : 'green'}>{type.toUpperCase()}</Tag>
                },
                {
                    title: '‰ºòÂÖàÁ∫ß',
                    dataIndex: 'priority',
                    key: 'priority',
                    width: 80,
                    render: (p) => <Tag color={p === 'P0' ? 'red' : p === 'P1' ? 'orange' : 'default'}>{p}</Tag>
                },
                {
                    title: 'Êìç‰Ωú',
                    key: 'action',
                    width: 240,
                    render: (_, record) => (
                        <Space size="small">
                            <Button
                                type="primary"
                                size="small"
                                loading={executing[record.testId]}
                                onClick={() => handleExecuteTest(record.testId)}
                            >
                                ‚ñ∂ ÊâßË°å
                            </Button>
                            <Button size="small" onClick={() => handleViewHistory(record)}>
                                üìä ÂéÜÂè≤
                            </Button>
                            <Button size="small" onClick={() => handleEditTest(record)}>
                                ‚úèÔ∏è ÁºñËæë
                            </Button>
                            <Popconfirm
                                title="Á°ÆÂÆöÂà†Èô§Ôºü"
                                onConfirm={() => handleDeleteTest(record.testId)}
                                okText="Á°ÆÂÆö"
                                cancelText="ÂèñÊ∂à"
                            >
                                <Button danger size="small">üóëÔ∏è</Button>
                            </Popconfirm>
                        </Space>
                    )
                }
            ];

            const treeData = buildTreeData(groups);

            return (
                <Layout className="app-layout">
                    <Header style={{ display: 'flex', alignItems: 'center', background: '#001529' }}>
                        <div className="logo">üß™ ÊµãËØïÁÆ°ÁêÜÂπ≥Âè∞</div>
                        <div style={{ flex: 1 }} />
                        <Space>
                            <Button onClick={() => setCreateGroupModalVisible(true)}>
                                ‚ûï Êñ∞Âª∫ÂàÜÁªÑ
                            </Button>
                            <Button type="primary" onClick={() => {
                                loadGroups();
                                loadTests(selectedGroup);
                                loadStats();
                            }}>
                                üîÑ Âà∑Êñ∞
                            </Button>
                        </Space>
                    </Header>
                    <Layout>
                        <Sider width={300} style={{ background: '#fff', padding: '16px' }}>
                            <h3>üìã ÊµãËØïÂàÜÁªÑ</h3>
                            <Tree
                                defaultExpandAll
                                treeData={treeData}
                                onSelect={(keys) => {
                                    setSelectedGroup(keys[0] || null);
                                    loadTests(keys[0] || null);
                                }}
                            />
                        </Sider>
                        <Layout style={{ padding: '24px' }}>
                            <Content>
                                <Row gutter={16} style={{ marginBottom: 24 }}>
                                    <Col span={6}>
                                        <Card><Statistic title="ÊÄªÊµãËØïÊï∞" value={stats.total || 0} /></Card>
                                    </Col>
                                    <Col span={6}>
                                        <Card><Statistic title="Ê¥ªË∑ÉÊµãËØï" value={stats.active || 0} valueStyle={{ color: '#3f8600' }} /></Card>
                                    </Col>
                                    <Col span={6}>
                                        <Card><Statistic title="P0" value={stats.p0 || 0} valueStyle={{ color: '#cf1322' }} /></Card>
                                    </Col>
                                    <Col span={6}>
                                        <Card><Statistic title="P1" value={stats.p1 || 0} valueStyle={{ color: '#fa8c16' }} /></Card>
                                    </Col>
                                </Row>

                                <Card
                                    title={selectedGroup ? `üìù ${selectedGroup}` : 'üìù ÊâÄÊúâÊµãËØïÁî®‰æã'}
                                    extra={
                                        <Button type="primary" onClick={() => setCreateTestModalVisible(true)}>
                                            ‚ûï Êñ∞Âª∫ÊµãËØï
                                        </Button>
                                    }
                                >
                                    <Table
                                        columns={testColumns}
                                        dataSource={tests}
                                        rowKey="testId"
                                        loading={loading}
                                        pagination={{ pageSize: 10 }}
                                    />
                                </Card>
                            </Content>
                        </Layout>
                    </Layout>

                    {/* Create Group Modal */}
                    <Modal
                        title={parentGroupForCreate ? `‚ûï ÂàõÂª∫Â≠êÂàÜÁªÑ (Áà∂ÂàÜÁªÑ: ${parentGroupForCreate.name})` : "‚ûï ÂàõÂª∫ÊµãËØïÂàÜÁªÑ"}
                        open={createGroupModalVisible}
                        onCancel={() => {
                            setCreateGroupModalVisible(false);
                            groupForm.resetFields();
                            setParentGroupForCreate(null);
                        }}
                        onOk={() => groupForm.submit()}
                        width={600}
                    >
                        <Form form={groupForm} layout="vertical" onFinish={handleCreateGroup}>
                            <Form.Item name="groupId" label="ÂàÜÁªÑID" rules={[{ required: true, message: 'ËØ∑ËæìÂÖ•ÂàÜÁªÑID' }]}>
                                <Input placeholder="‰æãÂ¶ÇÔºöapi-tests" />
                            </Form.Item>
                            <Form.Item name="name" label="ÂàÜÁªÑÂêçÁß∞" rules={[{ required: true, message: 'ËØ∑ËæìÂÖ•ÂàÜÁªÑÂêçÁß∞' }]}>
                                <Input placeholder="‰æãÂ¶ÇÔºöAPI Tests" />
                            </Form.Item>
                            <Form.Item name="parentId" label="Áà∂ÂàÜÁªÑID">
                                <Input
                                    placeholder="ÁïôÁ©∫Ë°®Á§∫È°∂Á∫ßÂàÜÁªÑ"
                                    disabled={!!parentGroupForCreate}
                                />
                            </Form.Item>
                            <Form.Item name="description" label="ÊèèËø∞">
                                <TextArea rows={3} placeholder="ÂàÜÁªÑÊèèËø∞" />
                            </Form.Item>
                            <Form.Item
                                name="targetHost"
                                label="ÁõÆÊ†áÊúçÂä°Âú∞ÂùÄ"
                                tooltip="ËØ•ÂàÜÁªÑ‰∏ãÊâÄÊúâÊµãËØïÁî®‰æãÂ∞Ü‰ΩøÁî®Ê≠§Âú∞ÂùÄ„ÄÇÁïôÁ©∫Âàô‰ΩøÁî®ÂÖ®Â±ÄÈÖçÁΩÆ„ÄÇ"
                            >
                                <Input placeholder="‰æãÂ¶ÇÔºöhttp://127.0.0.1:9095" />
                            </Form.Item>
                        </Form>
                    </Modal>

                    {/* Edit Group Modal */}
                    <Modal
                        title="‚úèÔ∏è ÁºñËæëÊµãËØïÂàÜÁªÑ"
                        open={editGroupModalVisible}
                        onCancel={() => { setEditGroupModalVisible(false); editGroupForm.resetFields(); setCurrentGroup(null); }}
                        onOk={() => editGroupForm.submit()}
                        width={600}
                    >
                        <Form form={editGroupForm} layout="vertical" onFinish={handleUpdateGroup}>
                            <Form.Item name="name" label="ÂàÜÁªÑÂêçÁß∞" rules={[{ required: true }]}>
                                <Input />
                            </Form.Item>
                            <Form.Item name="description" label="ÊèèËø∞">
                                <TextArea rows={3} />
                            </Form.Item>
                            <Form.Item
                                name="targetHost"
                                label="ÁõÆÊ†áÊúçÂä°Âú∞ÂùÄ"
                                tooltip="ËØ•ÂàÜÁªÑ‰∏ãÊâÄÊúâÊµãËØïÁî®‰æãÂ∞Ü‰ΩøÁî®Ê≠§Âú∞ÂùÄ„ÄÇÁïôÁ©∫Âàô‰ΩøÁî®ÂÖ®Â±ÄÈÖçÁΩÆ„ÄÇ"
                            >
                                <Input placeholder="‰æãÂ¶ÇÔºöhttp://127.0.0.1:9095" />
                            </Form.Item>
                        </Form>
                    </Modal>

                    {/* Create Test Modal */}
                    <Modal
                        title="‚ûï ÂàõÂª∫ÊµãËØïÁî®‰æã"
                        open={createTestModalVisible}
                        onCancel={() => { setCreateTestModalVisible(false); testForm.resetFields(); }}
                        onOk={() => testForm.submit()}
                        width={800}
                    >
                        <Form form={testForm} layout="vertical" onFinish={handleCreateTest}>
                            <Row gutter={16}>
                                <Col span={12}>
                                    <Form.Item name="testId" label="ÊµãËØïID" rules={[{ required: true }]}>
                                        <Input placeholder="test-001" />
                                    </Form.Item>
                                </Col>
                                <Col span={12}>
                                    <Form.Item name="groupId" label="ÂàÜÁªÑ" rules={[{ required: true }]}>
                                        <Select placeholder="ÈÄâÊã©ÂàÜÁªÑ">
                                            {groups.map(g => <Option key={g.groupId} value={g.groupId}>{g.name}</Option>)}
                                        </Select>
                                    </Form.Item>
                                </Col>
                            </Row>
                            <Row gutter={16}>
                                <Col span={12}>
                                    <Form.Item name="name" label="ÂêçÁß∞" rules={[{ required: true }]}>
                                        <Input />
                                    </Form.Item>
                                </Col>
                                <Col span={6}>
                                    <Form.Item name="type" label="Á±ªÂûã" rules={[{ required: true }]}>
                                        <Select>
                                            <Option value="http">HTTP</Option>
                                            <Option value="command">Command</Option>
                                        </Select>
                                    </Form.Item>
                                </Col>
                                <Col span={6}>
                                    <Form.Item name="priority" label="‰ºòÂÖàÁ∫ß" initialValue="P1">
                                        <Select>
                                            <Option value="P0">P0</Option>
                                            <Option value="P1">P1</Option>
                                            <Option value="P2">P2</Option>
                                        </Select>
                                    </Form.Item>
                                </Col>
                            </Row>
                            <Form.Item name="objective" label="ÁõÆÊ†á">
                                <TextArea rows={2} />
                            </Form.Item>

                            <Form.Item noStyle shouldUpdate={(prev, curr) => prev.type !== curr.type}>
                                {({ getFieldValue }) => {
                                    const type = getFieldValue('type');
                                    if (type === 'http') {
                                        return (
                                            <>
                                                <Row gutter={16}>
                                                    <Col span={8}>
                                                        <Form.Item name="httpMethod" label="ÊñπÊ≥ï" initialValue="GET">
                                                            <Select>
                                                                <Option value="GET">GET</Option>
                                                                <Option value="POST">POST</Option>
                                                                <Option value="PUT">PUT</Option>
                                                                <Option value="DELETE">DELETE</Option>
                                                            </Select>
                                                        </Form.Item>
                                                    </Col>
                                                    <Col span={16}>
                                                        <Form.Item name="httpPath" label="Ë∑ØÂæÑ">
                                                            <Input placeholder="/api/endpoint" />
                                                        </Form.Item>
                                                    </Col>
                                                </Row>
                                                <Form.Item name="httpHeaders" label="Headers (JSON)">
                                                    <TextArea rows={3} placeholder='{"Content-Type": "application/json"}' />
                                                </Form.Item>
                                                <Form.Item name="httpBody" label="Body (JSON)">
                                                    <TextArea rows={4} placeholder='{"key": "value"}' />
                                                </Form.Item>
                                            </>
                                        );
                                    } else if (type === 'command') {
                                        return (
                                            <>
                                                <Form.Item name="cmdCommand" label="ÂëΩ‰ª§">
                                                    <Input placeholder="echo" />
                                                </Form.Item>
                                                <Form.Item name="cmdArgs" label="ÂèÇÊï∞">
                                                    <Input placeholder="hello world" />
                                                </Form.Item>
                                                <Form.Item name="cmdTimeout" label="Ë∂ÖÊó∂(Áßí)" initialValue={60}>
                                                    <Input type="number" />
                                                </Form.Item>
                                            </>
                                        );
                                    }
                                    return null;
                                }}
                            </Form.Item>

                            <Form.Item name="assertions" label="Êñ≠Ë®Ä (JSON)">
                                <TextArea rows={4} placeholder='[{"type": "status_code", "expected": 200}]' />
                            </Form.Item>
                            <Form.Item name="tags" label="Ê†áÁ≠æ">
                                <Input placeholder="api, smoke" />
                            </Form.Item>

                            <Form.Item name="setupHooks" label="Setup Hooks (JSON)">
                                <TextArea
                                    rows={4}
                                    placeholder='[{"type": "http", "name": "Setup hook", "http": {"method": "GET", "path": "/health"}, "continueOnError": false}]'
                                />
                            </Form.Item>

                            <Form.Item name="teardownHooks" label="Teardown Hooks (JSON)">
                                <TextArea
                                    rows={4}
                                    placeholder='[{"type": "command", "name": "Cleanup", "command": {"cmd": "echo", "args": ["done"]}, "runOnFailure": true}]'
                                />
                            </Form.Item>
                        </Form>
                    </Modal>

                    {/* Edit Test Modal */}
                    <Modal
                        title="‚úèÔ∏è ÁºñËæëÊµãËØïÁî®‰æã"
                        open={editTestModalVisible}
                        onCancel={() => { setEditTestModalVisible(false); editTestForm.resetFields(); setCurrentTest(null); }}
                        onOk={() => editTestForm.submit()}
                        width={800}
                    >
                        <Form form={editTestForm} layout="vertical" onFinish={handleUpdateTest}>
                            <Form.Item name="name" label="ÂêçÁß∞" rules={[{ required: true }]}>
                                <Input />
                            </Form.Item>
                            <Row gutter={16}>
                                <Col span={12}>
                                    <Form.Item name="type" label="Á±ªÂûã">
                                        <Select disabled>
                                            <Option value="http">HTTP</Option>
                                            <Option value="command">Command</Option>
                                        </Select>
                                    </Form.Item>
                                </Col>
                                <Col span={12}>
                                    <Form.Item name="priority" label="‰ºòÂÖàÁ∫ß">
                                        <Select>
                                            <Option value="P0">P0</Option>
                                            <Option value="P1">P1</Option>
                                            <Option value="P2">P2</Option>
                                        </Select>
                                    </Form.Item>
                                </Col>
                            </Row>
                            <Form.Item name="objective" label="ÁõÆÊ†á">
                                <TextArea rows={2} />
                            </Form.Item>

                            <Form.Item noStyle shouldUpdate={(prev, curr) => prev.type !== curr.type}>
                                {({ getFieldValue }) => {
                                    const type = getFieldValue('type');
                                    if (type === 'http') {
                                        return (
                                            <>
                                                <Row gutter={16}>
                                                    <Col span={8}>
                                                        <Form.Item name="httpMethod" label="ÊñπÊ≥ï">
                                                            <Select>
                                                                <Option value="GET">GET</Option>
                                                                <Option value="POST">POST</Option>
                                                                <Option value="PUT">PUT</Option>
                                                                <Option value="DELETE">DELETE</Option>
                                                            </Select>
                                                        </Form.Item>
                                                    </Col>
                                                    <Col span={16}>
                                                        <Form.Item name="httpPath" label="Ë∑ØÂæÑ">
                                                            <Input />
                                                        </Form.Item>
                                                    </Col>
                                                </Row>
                                                <Form.Item name="httpHeaders" label="Headers">
                                                    <TextArea rows={3} />
                                                </Form.Item>
                                                <Form.Item name="httpBody" label="Body">
                                                    <TextArea rows={4} />
                                                </Form.Item>
                                            </>
                                        );
                                    } else if (type === 'command') {
                                        return (
                                            <>
                                                <Form.Item name="cmdCommand" label="ÂëΩ‰ª§">
                                                    <Input placeholder="echo" />
                                                </Form.Item>
                                                <Form.Item name="cmdArgs" label="ÂèÇÊï∞">
                                                    <Input placeholder="hello world" />
                                                </Form.Item>
                                                <Row gutter={16}>
                                                    <Col span={12}>
                                                        <Form.Item name="cmdTimeout" label="Ë∂ÖÊó∂(Áßí)">
                                                            <Input type="number" />
                                                        </Form.Item>
                                                    </Col>
                                                    <Col span={12}>
                                                        <Form.Item name="cmdCwd" label="Â∑•‰ΩúÁõÆÂΩï">
                                                            <Input placeholder="/path/to/directory" />
                                                        </Form.Item>
                                                    </Col>
                                                </Row>
                                            </>
                                        );
                                    }
                                    return null;
                                }}
                            </Form.Item>

                            <Form.Item name="assertions" label="Êñ≠Ë®Ä (JSON)">
                                <TextArea rows={4} placeholder='[{"type": "status_code", "expected": 200}]' />
                            </Form.Item>
                            <Form.Item name="tags" label="Ê†áÁ≠æ">
                                <Input placeholder="api, smoke" />
                            </Form.Item>

                            <Form.Item name="setupHooks" label="Setup Hooks (JSON)">
                                <TextArea
                                    rows={4}
                                    placeholder='[{"type": "http", "name": "Setup hook", "http": {"method": "GET", "path": "/health"}, "continueOnError": false}]'
                                />
                            </Form.Item>

                            <Form.Item name="teardownHooks" label="Teardown Hooks (JSON)">
                                <TextArea
                                    rows={4}
                                    placeholder='[{"type": "command", "name": "Cleanup", "command": {"cmd": "echo", "args": ["done"]}, "runOnFailure": true}]'
                                />
                            </Form.Item>
                        </Form>
                    </Modal>

                    {/* Test History Drawer */}
                    <Drawer
                        title={`üìä ÊµãËØïÂéÜÂè≤ - ${currentTest?.name}`}
                        placement="right"
                        width={720}
                        open={testHistoryDrawerVisible}
                        onClose={() => { setTestHistoryDrawerVisible(false); setCurrentTest(null); setTestResults([]); }}
                    >
                        {testResults.length === 0 ? (
                            <div style={{ textAlign: 'center', padding: 40 }}>ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</div>
                        ) : (
                            <Space direction="vertical" style={{ width: '100%' }} size="large">
                                {testResults.map((result, index) => (
                                    <Card
                                        key={result.id}
                                        size="small"
                                        title={
                                            <Space>
                                                <span>ÊâßË°å #{testResults.length - index}</span>
                                                <Tag color={
                                                    result.status === 'passed' ? 'success' :
                                                    result.status === 'failed' ? 'error' : 'warning'
                                                }>
                                                    {result.status.toUpperCase()}
                                                </Tag>
                                            </Space>
                                        }
                                    >
                                        <Descriptions size="small" column={2}>
                                            <Descriptions.Item label="Êó∂Èó¥">
                                                {new Date(result.startTime).toLocaleString('zh-CN')}
                                            </Descriptions.Item>
                                            <Descriptions.Item label="ËÄóÊó∂">
                                                {result.duration}ms
                                            </Descriptions.Item>
                                        </Descriptions>
                                        {result.error && (
                                            <div style={{ marginTop: 12 }}>
                                                <strong>ÈîôËØØ:</strong>
                                                <div className="json-viewer">{result.error}</div>
                                            </div>
                                        )}
                                        {result.failures && result.failures.length > 0 && (
                                            <div style={{ marginTop: 12 }}>
                                                <strong>Â§±Ë¥•:</strong>
                                                <div className="json-viewer">
                                                    {result.failures.map((f, i) => (
                                                        <div key={i}>‚Ä¢ {typeof f === 'string' ? f : JSON.stringify(f)}</div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </Card>
                                ))}
                            </Space>
                        )}
                    </Drawer>
                </Layout>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
